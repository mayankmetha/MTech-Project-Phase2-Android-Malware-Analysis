#!/usr/local/bin/python3
from os import listdir
from os.path import isfile, join

import multiprocessing
import psutil
import sys

# path
apkpath = '../test/raw/'
dexpath = '../test/dex/'
manifestpath = '../test/manifest/'
dataset = '../test/dataset/'

apk = []

# apk list
if len(sys.argv) == 2:
    apk.append(sys.argv[1])
else:
    apk.extend([f for f in listdir(apkpath) if isfile(join(apkpath,f))])

# merge file
def stitch(i):
    fout = open(join(dataset,i),'w')
    if isfile(join(manifestpath,i)):
        fm = open(join(manifestpath,i),'r')
        for _ in fm.readlines():
            fout.write(_)
        fm.close()
    if isfile(join(dexpath,i)):
        fd = open(join(dexpath,i),'r')
        for _ in fd.readlines():
            fout.write(_)
        fd.close()
    fout.close()

# Multi-core
if __name__ == '__main__':
    pool = multiprocessing.Pool(processes=psutil.cpu_count())
    for i in apk:
        pool.apply_async(stitch, args=(i,))
    pool.close()
    pool.join()